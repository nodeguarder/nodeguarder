name: nodeguarder



services:
  app:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
      args:
        - GO_BUILD_TAGS=enterprise
        - VERSION=${VERSION:-1.0.0}
        - INCLUDE_LICENSE_GENERATOR=true
    container_name: nodeguarder-app
    environment:
      - DB_PATH=/data/nodeguarder.db
      - INCLUDE_LICENSE_GENERATOR=true
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}
      - PORT=8080
      - LICENSE_PATH=/app/license_data/license.yaml
    volumes:
      - ./data:/data
      - ./license_data:/app/license_data
      - ./license_tool/private.key:/app/private.key
      - ../dashboard/backend/public.key:/app/public.key
    ports:
      - "8081:8080"
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  nginx:
    image: nginx:alpine
    container_name: nodeguarder-nginx
    ports:
      - "8443:443"
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
    depends_on:
      - app
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  data:
